<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gerador de Pix</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">
  <!-- jsPDF para gerar PDF no pr√≥prio celular -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1222);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 64px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{font-size:clamp(20px,4vw,28px);margin:8px 0}
    .card{background:var(--card);border:1px solid #223046;border-radius:14px;padding:14px;box-shadow:0 10px 20px rgb(0 0 0 / .25);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:14px;color:var(--muted)}
    select,input,textarea{
      width:100%;padding:10px 12px;border:1px solid #2a3a4f;border-radius:10px;background:#0f1b2a;color:#e5e7eb;
      font-size:15px;outline:none;
    }
    select:focus,input:focus,textarea:focus{border-color:#60a5fa;box-shadow:0 0 0 1px #1d4ed8}
    input::placeholder,textarea::placeholder{color:#6b7b8d}
    textarea{min-height:80px;resize:vertical;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted);margin-top:2px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
    .pill{display:inline-block;background:#0c2235;border:1px solid #1e3a5f;color:#bcd2eb;padding:4px 8px;border-radius:999px;font-size:12px}
    .accent{color:var(--accent);font-weight:700}
    .btn{width:100%;margin-top:8px;padding:12px;border-radius:10px;border:1px solid #244a34;background:#11251a;color:#c6f6d5;font-weight:700;cursor:pointer}
    .btn-secondary{width:100%;margin-top:8px;padding:10px;border-radius:10px;border:1px solid #334155;background:#020617;color:#e5e7eb;font-size:14px;cursor:pointer}
    .btn-danger{width:100%;margin-top:8px;padding:10px;border-radius:10px;border:1px solid #7f1d1d;background:#450a0a;color:#fecaca;font-size:14px;cursor:pointer}
    .btn:disabled,.btn-secondary:disabled,.btn-danger:disabled{opacity:.5;cursor:not-allowed}
    .error{color:var(--danger);font-size:12px;margin-top:4px}
    .qr-wrap{margin-top:8px;text-align:center}
    .qr-img{max-width:260px;width:100%;border-radius:10px;background:#020617;border:1px solid #1f2937;padding:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gerador de Pix</h1>
      <span class="pill">Copia e cola ‚Ä¢ Offline PWA</span>
    </header>

    <div class="card">
      <div class="grid">
        <div>
          <label for="tipoChave">Tipo de chave Pix</label>
          <select id="tipoChave">
            <option value="cpf">CPF</option>
            <option value="cnpj">CNPJ</option>
            <option value="email">E-mail</option>
            <option value="tel">Telefone</option>
            <option value="aleatoria">Chave aleat√≥ria</option>
          </select>
          <div id="exemplo" class="hint"></div>
        </div>

        <div>
          <label for="chave">Chave Pix</label>
          <input id="chave" type="text" placeholder="" />
        </div>

        <div class="row">
          <div>
            <label for="valor">Valor (R$) ‚Äî opcional</label>
            <input id="valor" type="text" inputmode="decimal" placeholder="ex.: 149,90" />
          </div>
          <div>
            <label for="nome">Nome do recebedor</label>
            <input id="nome" type="text" placeholder="Ex.: LOJA IBA STORE" />
            <div class="hint">Este nome aparecer√° no extrato do Pix para quem receber o pagamento.</div>
          </div>
        </div>

        <div>
          <label for="descricao">Descri√ß√£o para o pagador (opcional)</label>
          <textarea id="descricao" placeholder="Ex.: PAGAMENTO PRODUTO X OU N√öMERO DO PEDIDO"></textarea>
          <div class="hint">M√°x. 50 caracteres, sem acento ou emoji. Ser√° convertido para mai√∫sculas.</div>
        </div>

        <div id="erro" class="error"></div>

        <button id="btnGerar" class="btn">‚öôÔ∏è Therar c√≥digo Pix + QR Code</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="codigo">C√≥digo Pix (copia e cola)</label>
          <textarea id="codigo" readonly placeholder="O c√≥digo Pix aparecer√° aqui ap√≥s gerar."></textarea>
          <button id="btnCopiar" class="btn-secondary">üìã Copiar c√≥digo</button>
        </div>

        <div>
          <label>QR Code do Pix</label>
          <div class="hint">Use para ler o Pix diretamente na c√¢mera de outro celular.</div>
          <div class="qr-wrap">
            <img id="qrImg" class="qr-img" alt="QR Code Pix" style="display:none;" />
          </div>
          <button id="btnShareQr" class="btn-secondary" style="margin-top:10px;">üì§ Enviar QR + c√≥digo como legenda</button>
          <div class="hint">
            Tenta enviar a imagem do QR Code com o c√≥digo copia e cola como legenda. Funciona apenas em aparelhos/navegadores que suportam compartilhamento com imagem.
          </div>
        </div>

        <div>
          <button id="btnWhats" class="btn">üì§ Enviar s√≥ o c√≥digo pelo WhatsApp</button>
          <div class="hint">
            O c√≥digo ser√° enviado sozinho, sem texto adicional.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Hist√≥rico de Pix gerados</h2>
      <div class="grid">
        <textarea id="historico" readonly placeholder="Nenhum registro ainda."></textarea>
        <button id="btnRefreshLog" class="btn-secondary">üîÑ Atualizar hist√≥rico</button>
        <button id="btnWhatsLog" class="btn-secondary">üì§ Enviar relat√≥rio em texto (WhatsApp)</button>
        <button id="btnPdf" class="btn-secondary">üìÑ Baixar relat√≥rio em PDF</button>
        <button id="btnWhatsPdf" class="btn-secondary">üì§ Enviar relat√≥rio em PDF (WhatsApp)</button>
        <button id="btnClearLog" class="btn-danger">üóëÔ∏è Limpar hist√≥rico</button>
        <div class="hint">
          Este hist√≥rico √© local deste aparelho e armazena <strong>apenas os √∫ltimos 100 Pix gerados</strong>.
          Use "Limpar hist√≥rico" para come√ßar uma nova lista quando quiser.
        </div>
      </div>
    </div>
  </div>

  <script>
    const tipoChave = document.getElementById('tipoChave');
    const exemplo = document.getElementById('exemplo');
    const chave = document.getElementById('chave');
    const valor = document.getElementById('valor');
    const nome = document.getElementById('nome');
    const descricao = document.getElementById('descricao');
    const erro = document.getElementById('erro');
    const btnGerar = document.getElementById('btnGerar');
    const codigo = document.getElementById('codigo');
    const btnCopiar = document.getElementById('btnCopiar');
    const btnWhats = document.getElementById('btnWhats');
    const btnShareQr = document.getElementById('btnShareQr');
    const qrImg = document.getElementById('qrImg');

    const historico = document.getElementById('historico');
    const btnRefreshLog = document.getElementById('btnRefreshLog');
    const btnWhatsLog = document.getElementById('btnWhatsLog');
    const btnPdf = document.getElementById('btnPdf');
    const btnWhatsPdf = document.getElementById('btnWhatsPdf');
    const btnClearLog = document.getElementById('btnClearLog');

    const exemplos = {
      cpf: 'Digite apenas n√∫meros. Exemplo: 10766432726',
      cnpj: 'Digite apenas n√∫meros. Exemplo: 12345678000199',
      email: 'Exemplo de e-mail: exemplo@dominio.com',
      tel: 'Telefone: digite apenas DDD + n√∫mero. Ex.: 21999990000',
      aleatoria: 'Exemplo de chave aleat√≥ria: 123e4567e89b12d3a456426614174000'
    };

    const placeholders = {
      cpf: 'Ex.: 10766432726',
      cnpj: 'Ex.: 12345678000199',
      email: 'Ex.: exemplo@dominio.com',
      tel: 'Ex.: 21999990000',
      aleatoria: 'Ex.: 123e4567e89b12d3a456426614174000'
    };

    function getQrUrl(payload){
      const base = 'https://api.qrserver.com/v1/create-qr-code/';
      const params = '?size=260x260&data=' + encodeURIComponent(payload);
      return base + params;
    }

    function atualizarExemplo(){
      const tipo = tipoChave.value;
      exemplo.textContent = exemplos[tipo] || '';
      chave.placeholder = placeholders[tipo] || '';
    }
    tipoChave.addEventListener('change', atualizarExemplo);
    atualizarExemplo();

    // Persist√™ncia simples (sem salvar a descri√ß√£o)
    const SAVED = JSON.parse(localStorage.getItem('pix-generator-v9') || '{}');
    ['tipoChave','chave','valor','nome'].forEach(id => {
      if(SAVED[id]){
        if(id === 'tipoChave') tipoChave.value = SAVED[id];
        else document.getElementById(id).value = SAVED[id];
      }
    });
    atualizarExemplo();

    function salvarCamposBasicos(){
      const data = {
        tipoChave: tipoChave.value,
        chave: chave.value,
        valor: valor.value,
        nome: nome.value
      };
      localStorage.setItem('pix-generator-v9', JSON.stringify(data));
    }
    [tipoChave,chave,valor,nome].forEach(el => el.addEventListener('input', salvarCamposBasicos));

    // Sanitiza√ß√£o em tempo real da descri√ß√£o (sem salvar)
    descricao.addEventListener('input', () => {
      let cur = descricao.value;
      cur = cur.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      cur = cur.toUpperCase();
      cur = cur.replace(/[^A-Z0-9 \-\.]/g, '');
      if(cur.length > 50){
        cur = cur.substring(0,50);
      }
      descricao.value = cur;
    });

    function tlv(id, value){
      const len = String(value.length).padStart(2, '0');
      return id + len + value;
    }

    function sanitizeText(str, max){
      if(!str) return '';
      let s = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      s = s.toUpperCase();
      s = s.replace(/[^A-Z0-9 \-\.]/g, '');
      if(max) s = s.substring(0, max);
      return s;
    }

    function toNum(str){
      if(!str) return NaN;
      str = String(str).trim().replace(/\./g,'').replace(',','.');
      const n = Number(str);
      return isNaN(n) ? NaN : n;
    }

    function crc16(payload){
      let crc = 0xFFFF;
      for(let i=0;i<payload.length;i++){
        crc ^= payload.charCodeAt(i) << 8;
        for(let j=0;j<8;j++){
          if((crc & 0x8000) !== 0){
            crc = (crc << 1) ^ 0x1021;
          }else{
            crc = crc << 1;
          }
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }

    function carregarLog(){
      try{
        return JSON.parse(localStorage.getItem('pix-log-v1') || '[]');
      }catch(e){
        return [];
      }
    }

    function salvarLog(log){
      localStorage.setItem('pix-log-v1', JSON.stringify(log));
    }

    function formatarData(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return '';
      const pad = n => String(n).padStart(2,'0');
      return pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear() +
             ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    function atualizarHistoricoTexto(){
      const log = carregarLog();
      if(!log.length){
        historico.value = 'Nenhum registro ainda.';
        return;
      }
      const linhas = log.map(r => {
        return '[' + formatarData(r.dataIso) + '] ' +
               'ID: ' + (r.id || '-') +
               ' | Valor: ' + (r.valor || '-') +
               ' | Recebedor: ' + (r.recebedor || '-') +
               ' | Msg: ' + (r.mensagem || '-');
      });
      historico.value = linhas.join('\n');
    }

    btnRefreshLog.addEventListener('click', atualizarHistoricoTexto);

    btnWhatsLog.addEventListener('click', () => {
      const log = carregarLog();
      if(!log.length){
        erro.textContent = 'Nenhum registro no hist√≥rico para enviar.';
        return;
      }
      const linhas = log.map(r => {
        return '[' + formatarData(r.dataIso) + '] ' +
               'ID: ' + (r.id || '-') +
               ' | Valor: ' + (r.valor || '-') +
               ' | Recebedor: ' + (r.recebedor || '-') +
               ' | Msg: ' + (r.mensagem || '-');
      });
      const rel = 'RELATORIO DE PIX GERADOS\n' + linhas.join('\n');
      const url = 'https://wa.me/?text=' + encodeURIComponent(rel);
      window.open(url,'_blank');
    });

    btnClearLog.addEventListener('click', () => {
      const ok = confirm('Tem certeza que deseja limpar todo o hist√≥rico de Pix deste aparelho?');
      if(!ok) return;
      salvarLog([]);
      atualizarHistoricoTexto();
      erro.textContent = '';
    });

    function registrarNoLog(txid, amountStr, nomeSan, descSan){
      const agora = new Date();
      const registro = {
        id: txid || '',
        valor: valor.value || amountStr || '',
        recebedor: nomeSan || '',
        mensagem: descSan || '',
        dataIso: agora.toISOString()
      };
      let log = carregarLog();
      log.unshift(registro);
      if(log.length > 100){
        log = log.slice(0,100);
      }
      salvarLog(log);
    }

    function gerarPayloadPix(registrar){
      erro.textContent = '';
      let cRaw = chave.value.trim();
      if(!cRaw){
        erro.textContent = 'Informe a chave Pix.';
        return null;
      }

      let c = cRaw;

      if(tipoChave.value === 'tel'){
        const soNumeros = cRaw.replace(/\D/g,'');
        if(soNumeros.length < 10){
          erro.textContent = 'Telefone inv√°lido. Use apenas n√∫meros: DDD + n√∫mero. Ex.: 21999990000.';
          return null;
        }
        c = '+55' + soNumeros;
      } else if(tipoChave.value === 'cpf'){
        const soNumeros = cRaw.replace(/\D/g,'');
        if(soNumeros.length !== 11){
          erro.textContent = 'CPF inv√°lido. Digite 11 n√∫meros sem pontos ou tra√ßo.';
          return null;
        }
        c = soNumeros;
      } else if(tipoChave.value === 'cnpj'){
        const soNumeros = cRaw.replace(/\D/g,'');
        if(soNumeros.length !== 14){
          erro.textContent = 'CNPJ inv√°lido. Digite 14 n√∫meros sem pontos, barra ou tra√ßo.';
          return null;
        }
        c = soNumeros;
      }

      const nomeSan = sanitizeText(nome.value || 'RECEBEDOR', 25);
      const cidadeSan = 'RIO DE JANEIRO';
      const descSan = sanitizeText(descricao.value || '', 50);

      const amountNum = toNum(valor.value);
      const hasAmount = !isNaN(amountNum) && amountNum > 0;
      const amountStr = hasAmount ? amountNum.toFixed(2) : '';

      let txid = 'TX' + Date.now().toString().slice(-8);
      txid = sanitizeText(txid, 25);

      let mai = '';
      mai += tlv('00','BR.GOV.BCB.PIX');
      mai += tlv('01', c);
      if(descSan){
        mai += tlv('02', descSan);
      }
      const gui26 = tlv('26', mai);

      let payload = '';
      payload += tlv('00','01');
      payload += tlv('01','11');
      payload += gui26;
      payload += tlv('52','0000');
      payload += tlv('53','986');
      if(hasAmount){
        payload += tlv('54', amountStr);
      }
      payload += tlv('58','BR');
      payload += tlv('59', nomeSan);
      payload += tlv('60', cidadeSan);
      const addData = tlv('05', txid);
      payload += tlv('62', addData);

      const semCRC = payload + '6304';
      const crc = crc16(semCRC);
      payload = semCRC + crc;

      if(registrar){
        registrarNoLog(txid, amountStr, nomeSan, descSan);
        atualizarHistoricoTexto();
      }

      return payload;
    }

    function atualizarQr(payload){
      if(!payload){
        qrImg.style.display = 'none';
        qrImg.src = '';
        return;
      }
      const url = getQrUrl(payload);
      qrImg.src = url;
      qrImg.style.display = 'block';
    }

    btnGerar.addEventListener('click', () => {
      const p = gerarPayloadPix(true); // registra no log
      if(p){
        codigo.value = p;
        atualizarQr(p);
      }else{
        codigo.value = '';
        atualizarQr('');
      }
    });

    btnCopiar.addEventListener('click', async () => {
      if(!codigo.value){
        return;
      }
      try{
        await navigator.clipboard.writeText(codigo.value);
        btnCopiar.textContent = '‚úÖ Copiado!';
        setTimeout(() => btnCopiar.textContent = 'üìã Copiar c√≥digo', 1500);
      }catch(e){
        btnCopiar.textContent = 'Copie manualmente o texto acima';
        setTimeout(() => btnCopiar.textContent = 'üìã Copiar c√≥digo', 2000);
      }
    });

    btnWhats.addEventListener('click', () => {
      if(!codigo.value){
        const p = gerarPayloadPix(true);
        if(!p) return;
        codigo.value = p;
        atualizarQr(p);
      }
      const msg = codigo.value;
      const url = 'https://wa.me/?text=' + encodeURIComponent(msg);
      window.open(url,'_blank');
    });

    btnShareQr.addEventListener('click', async () => {
      let payload = codigo.value.trim();
      if(!payload){
        payload = gerarPayloadPix(true);
        if(!payload){
          return;
        }
        codigo.value = payload;
        atualizarQr(payload);
      }

      const qrUrl = getQrUrl(payload);

      if(!navigator.share){
        erro.textContent = 'Compartilhamento com imagem n√£o √© suportado neste navegador/aparelho.';
        return;
      }

      try{
        const resp = await fetch(qrUrl);
        const blob = await resp.blob();
        const file = new File([blob], 'pix_qr.png', { type: blob.type || 'image/png' });

        if(navigator.canShare && !navigator.canShare({ files:[file] })){
          erro.textContent = 'Este aparelho n√£o suporta compartilhar imagem com legenda pelo navegador.';
          return;
        }

        await navigator.share({
          files: [file],
          text: codigo.value || payload
        });
      }catch(e){
        console.error(e);
        erro.textContent = 'N√£o foi poss√≠vel carregar o QR Code para compartilhar.';
      }
    });

    // === PDF do relat√≥rio ===

    async function gerarPdfBlobDoLog(){
      const log = carregarLog();
      if(!log.length){
        erro.textContent = 'Nenhum registro no hist√≥rico para gerar PDF.';
        return null;
      }
      if(!window.jspdf || !window.jspdf.jsPDF){
        erro.textContent = 'Biblioteca de PDF n√£o carregada (jspdf). Verifique a conex√£o na primeira vez.';
        return null;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p', unit:'mm', format:'a4'});

      doc.setFontSize(14);
      doc.text('RELATORIO DE PIX GERADOS', 105, 15, { align: 'center' });

      doc.setFontSize(9);
      let y = 25;
      const lineHeight = 5;

      doc.setFont(undefined, 'bold');
      doc.text('DATA/HORA', 10, y);
      doc.text('ID',        50, y);
      doc.text('VALOR',     95, y);
      doc.text('RECEBEDOR', 120, y);
      y += lineHeight;
      doc.setFont(undefined, 'normal');

      for(const r of log){
        if(y > 280){
          doc.addPage();
          y = 15;
        }
        const dataStr = formatarData(r.dataIso);
        const id = String(r.id || '');
        const val = String(r.valor || '');
        const rec = String(r.recebedor || '');
        const msg = String(r.mensagem || '');

        doc.text(dataStr, 10, y);
        doc.text(id,       50, y);
        doc.text(val,      95, y);
        doc.text(rec,     120, y);
        y += lineHeight;

        if(msg){
          const wrapped = doc.splitTextToSize('Msg: ' + msg, 180);
          for(const line of wrapped){
            if(y > 280){
              doc.addPage();
              y = 15;
            }
            doc.text(line, 10, y);
            y += lineHeight;
          }
        }
      }

      const blob = doc.output('blob');
      return blob;
    }

    btnPdf.addEventListener('click', async () => {
      const blob = await gerarPdfBlobDoLog();
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'relatorio_pix.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    });

    btnWhatsPdf.addEventListener('click', async () => {
      const blob = await gerarPdfBlobDoLog();
      if(!blob) return;

      if(!navigator.share){
        erro.textContent = 'Compartilhamento de arquivos n√£o √© suportado neste navegador/aparelho.';
        return;
      }

      const file = new File([blob], 'relatorio_pix.pdf', { type: 'application/pdf' });

      if(navigator.canShare && !navigator.canShare({ files: [file] })){
        erro.textContent = 'Este aparelho n√£o suporta compartilhar PDF pelo navegador.';
        return;
      }

      try{
        await navigator.share({
          files: [file],
          text: 'Relatorio de Pix gerados'
        });
      }catch(e){
        console.error(e);
      }
    });

    // Atualiza hist√≥rico ao abrir
    atualizarHistoricoTexto();

    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>
